# Концепт слоя бизнес логики и слоя представления для кассы

### Краткое описание

  Реализация соответствует паттерну MVC.  
  Роль контроллера выполняет понятие "сценарий".
  
#### Сценарий
    
  Сценарии могут быть разных типов, с аргументом и без, с результатом и без.      
  Базовый интерфейс см. ru.crystals.pos.bl.api.scenarios.Scenario.  
  
  Жизненный цикл может быть как singleton так и stateless класс.
  Экземпляр сценария может быть создан как в SpringContext, так и явным образом через конструктор.
  
  Сценарий это по сути контроллер, который:
   - обрабатывает события от действий пользователя
   - управляет слоем представления
   - вызывает методы модулей из инфраструктурного слоя, обрабатывает их события
   
  Управление сценариями (их запуском) выполняется только через менеджер ru.crystals.pos.bl.ScenarioManager,
  который в аргументе метода start передает сценарию интерфейс ru.crystals.pos.ui.UI для взаимодействия со слоем представления.
  
  Активных сценариев может быть несколько, т.к. сценарий может запустить дочерний сценарий.  
  Таким образом выстраивается цепочка:  
  Сц1 -> Сц2 -> Сц3 -> Сц4 -> Сц5
  
#### Обработка событий  
  
  События обрабатываются в последовательности: 5, 4, 3, 2, 1  
  Если сценарий реализует соответствующий интерфейс слушателя события, событие будет передано только ему.  
  Есть также возможность обрабатывать и управлять пересылкой событий следующему сценарию реализовав интерфейс
  ru.crystals.pos.bl.api.scenarios.special.ScenarioEventProcessor    
  Интерфейс-маркер ru.crystals.pos.bl.api.scenarios.special.IgnoreAllEvents предназначен для игнорирования обработки всех событий на время его, сценария, активности.  
  
  Все события от действий человека имеют базовый тип ru.crystals.pos.hw.events.HumanEvent  
  
  Иерархия классов событий:
```  
 HumanEvent (базовый интерфейс)
   +- HWHumanEvent (hardware события)
   |   +- HWBLHumanEvent (события для обработки сценариями)
   |   |   +- FuncKey    (функцианльные кнопки: ПОДИТОГ, ОПЛАТА БАНКОМ, ОТКРЫТЬ Д.Я. и пр.) 
   |   |   +- Barcode    (штрихкод от сканера)
   |   |   +- MSRTracks  (дорожки от считываетля магнитных карт)
   |   +- HWUIHumanEvent (события для обработки представлением)
   |   |   +- TypedKey   (печатаемые кнопки)
   |   |   +- ControlKey (кнопки управления: Enter, Esc, Backspace, Стрелки и т.д.)
   +- UIHumanEvent       (UI события)
```
  
  Сценарии обрабатывают только HWBLHumanEvent события и callback от UI (UIHumanEvent).
  Остальные события обрабатывает GUI.
  
  Все события поступают в одну очередь и уже из неё последовательно отправляются в соответствующий архитектурный слой.
  см. ru.crystals.pos.bl.events.HumanEventListener  
   
#### Взаимодействие с UI


#### Demo 
